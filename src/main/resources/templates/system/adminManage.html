<html xmlns:th="http://www.thymeleaf.org">
<div th:replace="inc/_header"></div>
<!-- rsa -->
<script type="text/javascript" th:src="@{/assets/js/rsa/rsa.js}"></script>
<script type="text/javascript" th:src="@{/assets/js/rsa/jsbn.js}"></script>
<script type="text/javascript" th:src="@{/assets/js/rsa/prng4.js}"></script>
<script type="text/javascript" th:src="@{/assets/js/rsa/rng.js}"></script>
<script type="text/javascript" th:src="@{/assets/js/jquery-3.5.1.min.js}"></script>
<!-- rsa -->

<script type="text/javascript" th:inline="javascript">
	/*<![CDATA[*/
	$(document).ready(function() {
		$(".lnb_4").addClass("open");
		$(".lnb_4_2").addClass("open").addClass("active");
		
		//검색 조건 유지
		changeSearchTextType(/*[[ ${dto.searchTextType}]]*/);
		$("#searchText").val(/*[[ ${dto.searchText}]]*/);
		
		//체크박스
		$("#checkAll").click(function() {
			if($("#checkAll").prop("checked")) {
				$("input[name=checkBox]").prop("checked", true);
			} else {
				$("input[name=checkBox]").prop("checked", false);
			}
		});
	});

	function goList(num) {
		$("#searchText").val($("#searchText").val().trim());
		$("#currentPage").val(num);

		var f = document.theForm;

		f.action = /*[[ @{/system/adminManage.do} ]]*/'/system/adminManage.do';
		f.method = "post";
		f.submit();
	}

	//검색 종류 선택
	function changeSearchTextType(type) {
		if (type == "ALL") {
			$("#searchTextType").val("");
			$("#searchField").text("전체");
		} else if (type == "ID") {
			$("#searchTextType").val("ID");
			$("#searchField").text("관리자 계정");
		} else if (type == "NAME") {
			$("#searchTextType").val("NAME");
			$("#searchField").text("이름");
		}
	}
	
	
	//관리자 삭제
	function delAdmin() {
		var token = $("meta[name='_csrf']").attr("content");
		var header = $("meta[name='_csrf_header']").attr("content");
		
		var chkCnt = 0;
		var chkArr = new Array();
		
		$("input[name=checkBox]").each(function() {
			if(this.checked) {
				chkCnt++;
				chkArr.push($(this).val());
			}
		});
		
		if(chkCnt < 1) {
			alert("선택된 데이터가 없습니다.");
			return;
		}
		
		
		if(!confirm("삭제하시겠습니까?")) {
			return;
		}
		
		$.ajax({
			beforeSend : function(xhr) {
				xhr.setRequestHeader(header, token);
			},
			url : /*[[ @{/system/delAdmin.do} ]]*/ '/system/delAdmin.do',
			type : "POST",
			data : {"luIds" : chkArr.join()},
			dataType : 'text',
			success : function(type) {
				if(type == "SUCCESS") {
					alert("정상적으로 삭제되었습니다.");
				} else {
					alert("삭제 처리 중 오류가 발생하였습니다.");
				}
			},
			error : function (e) {
				alert("시스템 에러가 발생하였습니다. 관리자에게 문의하세요.");
			},
			complete : function() {
				goList(1);
			}
		});
		
	}
	
	function modifyForm(userId,auth) {
		$("#userId").val(userId).text();
		$("#userName").val($("#tdName_"+userId).children().text());
		$("#modAuthSeq").val(auth);
	}
/*]]*/
</script>

<form id="theForm" name="theForm" method="post">
	<input type="hidden" id="blockCount" name="blockCount" th:value="${dto.blockCount}" /> 
	<input type="hidden" id="currentPage" name="currentPage" th:value="${dto.currentPage}" /> 
	<input type="hidden" id="searchTextType" name="searchTextType" th:value="${dto.searchTextType}" />
	<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
	<input type="hidden" name="rsaPublicKeyModules" id ="rsaPublicKeyModules" th:value="${session['rsaPublicKeyModules']}"/>
	<input type="hidden" name="rsaPublicKeyExponent" id="rsaPublicKeyExponent" th:value="${session['rsaPublicKeyExponent']}"/>
	<input type="hidden" name="encId" id="encId"/>
	<input type="hidden" name="encPw" id="encPw"/>
<!-- 컨텐츠 영역 -->
<div class="app-content content">
	<div class="content-wrapper">
		<!-- 컨텐츠:헤더-페이지명,네비게이터 -->
		<div class="content-header row">
			<div class="content-header-left col-md-8 col-12 mb-2 breadcrumb-new">
				<h3 class="content-header-title mb-0 d-inline-block">관리자 계정</h3>
				<div class="row breadcrumbs-top d-inline-block">
					<div class="breadcrumb-wrapper col-12">
						<ol class="breadcrumb">
							<li class="breadcrumb-item">Home</li>
							<li class="breadcrumb-item">시스템관리</li>
							<li class="breadcrumb-item active">관리자계정</li>
						</ol>
					</div>
				</div>
			</div>

		</div>
		<!--// 컨텐츠:헤더-페이지명,네비게이터 -->
		<!-- 컨텐츠:본문 영역 -->
		<div class="content-body">
			<!-- 디스크립션 -->
			<div class="bs-callout-success mb-2">
				<div class="media align-items-stretch">
					<div class="media-left d-flex align-items-center bg-gray p-2">
						<i class="ft-check-square white font-medium-5"></i>
					</div>
					<div class="media-body p-1">
						<ul class="list-left list-disc mb-0">
							<li>미디어서버를 관리하는 관리자 계정 페이지입니다.</li>
							<li>관리자 이름을 클릭하시면 해당 사용자 정보를 수정하실 수 있습니다.</li>
							<li>반드시 복잡한 암호를 지정해 미디어 서버를 보호하십시오.</li>
						</ul>
					</div>
				</div>
			</div>
			<!--// 디스크립션 -->

			<div class="row">
				<!-- 사용자 목록 -->
				<div class="col-xl-12">
					<div class="card">
						<div class="card-header">
							<h4 class="card-title">관리자 계정</h4>
							<div class="heading-elements">

								<!-- 검색 -->
								<div class="input-group input-group-sm">
									<div class="input-group-prepend">
										<button type="button" class="btn btn-light dropdown-toggle"
											data-toggle="dropdown" aria-haspopup="true"  id="searchField"
											aria-expanded="false">전체</button>
										<div class="dropdown-menu">
											<a class="dropdown-item"
												href="javascript:changeSearchTextType('ALL')">전체</a> <a
												class="dropdown-item"
												href="javascript:changeSearchTextType('ID')">관리자 계정</a> <a
												class="dropdown-item"
												href="javascript:changeSearchTextType('NAME')">이름</a>
										</div>
									</div>
									<input type="text" class="form-control"
										placeholder="검색어를 입력하세요." id="searchText" name="searchText">
									<div class="input-group-append">
										<button type="button" class="btn btn-info">
											<i class="fa fa-search" onclick="goList(1)"></i>
										</button>
									</div>
								</div>

								<!--// 검색 -->
							</div>
						</div>
						<div class="card-content">
							<div class="card-body">
								<!-- 버튼영역 -->
								<div class="position-relative">
									<div class="d-inline">
										<button type="button" class="btn btn-primary btn-sm"
											data-toggle="modal" data-target="#addUser">
											<i class="ft-user-plus"></i> 관리자 계정 등록
										</button>
										<button type="button" class="btn btn-secondary btn-sm " id="delBtn" th:onclick="delAdmin();">삭제</button>
									</div>
								</div>
								<!--// 버튼영역 -->

								<div class=" table-responsive even-line view-poll  mt-Half">
									<table cellpadding="0" cellspacing="0"
										class="w-100 table table-design-cust text-center mb-0"
										summary="">
										<colgroup>
											<col width="5%" />
											<col width="5%" />
											<col width="15%" />
											<col width="20%" />
											<col width="17.5%" />
											<col width="17.5%" />
											<col width="20%" />
										</colgroup>
										<thead>
											<tr>
												<th scope="row">
													<div class="form-check abc-checkbox">
														<input type="checkbox" class="form-check-input" id="checkAll" aria-label="Single checkbox 00">
														<label class="form-check-label" for="checkAll"></label>
													</div>
												</th>
												<th scope="row">No</th>
												<th scope="row">관리자 계정</th>
												<th scope="row">이름</th>
												<th scope="row">권한</th>
												<th scope="row">가입일</th>
												<th scope="row">접속일</th>
											</tr>
										</thead>
										<tbody>
											<tr th:if="${#lists.isEmpty(dto.userList)}">
												<td colspan="8"
													class="height-370 border-bottom border-light-gray ">검색결과가
													없습니다.</td>
											</tr>

											<tr th:unless="${#lists.isEmpty(dto.userList)}" th:each="item : ${dto.userList}">
												<td>
													<div class="form-check abc-checkbox">
														<input type="checkbox" class="form-check-input"
															name="checkBox" th:id="'checkbox'+${itemStat.index}" th:value="${item.luId}"aria-label="Single checkbox 01">
															<label class="form-check-label" th:for="'checkbox'+${itemStat.index}"></label>
													</div>
												</td>
												<td
													th:text="${dto.totalCount - (dto.blockCount * (dto.currentPage - 1) + itemStat.index)}"></td>
												<td th:text="${item.luId}"></td>
												<td th:id="'tdName_' + ${item.luId}"><a href="#" th:onclick="modifyForm([[ ${item.luId}]], [[ ${item.authSeq} ]])"
													data-toggle="modal" data-target="#modifyUser">[[${item.luName}]]</a></td>
												<td th:text="${item.authName}"></td>
												<td th:text="${item.regDate}"></td>
												<td th:text="${item.lastLoginDate}"></td>
											</tr>
										</tbody>
									</table>
								</div>
								<!--// 테이블 -->
								<!-- 페이징 -->
								<div th:utext="${dto.pagingHtml}"></div>
								<!-- //페이징 -->

							</div>
						</div>
					</div>
				</div>
				<!--// 사용자 목록 -->
				
			</div>
		</div>
		<!--// 컨텐츠 본문 영역 -->
		
	</div>
</div>
<!--// 컨텐츠 영역 -->
</form>
<!-- 스위치 버튼 JS -->
<script th:src="@{/app-assets/vendors/js/forms/toggle/bootstrap-switch.min.js}" type="text/javascript"></script>
<script th:src="@{/app-assets/vendors/js/forms/toggle/bootstrap-checkbox.min.js}" type="text/javascript"></script>
<script th:src="@{/app-assets/vendors/js/forms/toggle/switchery.min.js}" type="text/javascript"></script>
<script th:src="@{/app-assets/js/scripts/forms/switch.js}" type="text/javascript"></script>
<!--// 스위치 버튼 JS -->
<div th:replace="popup/addAdmin"></div>
<div th:replace="popup/modifyAdmin"></div>
<div th:replace="inc/_footer"></div>