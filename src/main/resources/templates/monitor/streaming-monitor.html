<html xmlns:th="http://www.thymeleaf.org">
<div th:replace="inc/_header"></div>
<!-- c3-chart CSS -->
  <link rel="stylesheet" type="text/css" th:href="@{/app-assets/css/plugins/charts/c3-chart.css}">
<!--// c3-chart CSS -->

<script type="text/javascript" th:inline="javascript">
/*<![CDATA[*/
$(function (){
	$(document).ready(function(){
		$(".lnb_1").addClass("open"); 
		$(".lnb_1_3").addClass("open").addClass("active");
	});
	
	
	
	cpuChart();
	memoryChart();
	driveChart();
	selectViewsType('views', 'ACCESS_TOTAL_CNT');
	
// 	getMonitorData();
	
	//1분마다 업데이트
// 	setInterval(getMonitorData, 60000);
});

function getMonitorData(){
	
	var token = $("meta[name='_csrf']").attr("content");
	var header = $("meta[name='_csrf_header']").attr("content");
	
	var jsonData = {
			"type" : $("#type").val(),
			"streamingSeq" : $("#streamingSeq").val(),
			"streamingIp"  : $("#streamingIp").val(),
			"viewsType" : $("#viewsType").val()
		};
	
	$.ajax({
		beforeSend : function(xhr) {   //데이터를 전송하기 전에 헤더에 csrf값을 설정한다
		    xhr.setRequestHeader(header, token);
		},
		type : "POST",
		url : /*[[@{/monitor/getMonitorData.do}]]*/ "/monitor/getMonitorData.do",
		data: jsonData,
		dataType : "JSON",
		success : function(data) {
			
			if($("#type").val() == "cpu"){
				cpuChart(data.liveMonitorList);
			} else if($("#type").val() == "memory"){
				memoryChart(data.liveMonitorList);
			} else if($("#type").val() == "drive"){
				driveChart(data.liveMonitorList);
			} else {
				viewsChart(data);
			}
// 			networkChart(data);
		
		},
		error : function(e) {
			alert("데이터를 받아오는 도중 에러가 발생하였습니다. 관리자에게 문의해주세요.");
		}
	});
	
}

function selectStreaming(type, seq){
	
	if(seq == null || seq == ""){
		return;
	}
	
	$("#type").val(type);
	$("#streamingSeq").val(seq);
	
	getMonitorData();
}


function selectViewsType(type, viewsType){
	$("#type").val(type);
	$("#viewsType").val(viewsType);
	
	getMonitorData();
}

/*]]*/
</script>

<!-- 컨텐츠 영역 -->
<div class="app-content content">
<div class="content-wrapper">
<!-- 컨텐츠:헤더-페이지명,네비게이터 -->
<div class="content-header row">
	<div class="content-header-left col-md-8 col-12 mb-2 breadcrumb-new">
		<h3 class="content-header-title mb-0 d-inline-block">라이브 스트리밍 모니터링</h3>
		<div class="row breadcrumbs-top d-inline-block">
			<div class="breadcrumb-wrapper col-12">
				<ol class="breadcrumb">
					<li class="breadcrumb-item">Home</li>
					<li class="breadcrumb-item">라이브방송관리</li>
					<li class="breadcrumb-item active">라이브스트리밍모니터링</li>
				</ol>
			</div>
		</div>
	</div>
</div>
<!--// 컨텐츠:헤더-페이지명,네비게이터 -->

<form id="theForm" name="theForm">
<input type="hidden" id="type" />
<input type="hidden" id="streamingSeq" />
<input type="hidden" id="viewsType" />

</form>

<!-- 컨텐츠:본문 영역 -->
<div class="content-body">

	<!-- 스트리밍 통계-->
	<div class="row">
		<div class="col-xl-12">
			<div class="card">
				<div class="card-header">
					<ul class="nav nav-tabs nav-top-border no-hover-bg">
						<li class="nav-item"><a class="nav-link active" id="statistics-tab1" data-toggle="tab" href="#statistics-1" aria-controls="statistics1" aria-expanded="true" onclick="selectViewsType('views', 'ACCESS_TOTAL_CNT')">접속자 수</a></li>
<!-- 						<li class="nav-item"><a class="nav-link" id="statistics-tab2" data-toggle="tab" href="#statistics-2" aria-controls="statistics2" aria-expanded="false">네트워크</a></li> -->
						<li class="nav-item"><a class="nav-link" id="statistics-tab3" data-toggle="tab" href="#statistics-3" aria-controls="statistics3" aria-expanded="false">CPU</a></li>
						<li class="nav-item"><a class="nav-link" id="statistics-tab4" data-toggle="tab" href="#statistics-4" aria-controls="statistics4" aria-expanded="false">메모리</a></li>
						<li class="nav-item"><a class="nav-link" id="statistics-tab5" data-toggle="tab" href="#statistics-5" aria-controls="statistics5" aria-expanded="false">드라이브</a></li>
					</ul>
				</div>

				<div class="card-content">
					<div class="card-body">
						<div class="tab-content">
						
							<!-- 접속자 탭 내용 -->
							<div role="tabpanel" class="tab-pane active" id="statistics-1" aria-labelledby="statistics-tab1" aria-expanded="true">
								<div class="position-relative">
									<h4 class="card-title">접속자</span></h4>
									<div class="position-absolute no-edge-top no-edge-right">
										<!-- WEB Mobile 선택 -->
										<select name="" title="" class="form-control" id="deviceOption" onchange="selectViewsType('views', this.value)">
											<option value="ACCESS_TOTAL_CNT" selected="selected">TOTAL</option>
											<option value="ACCESS_PC_CNT">WEB</option>
											<option value="ACCESS_MOBILE_CNT">Mobile</option>
										</select>	
										<!--// WEB Mobile 선택 -->
									</div>
								</div>
								<!-- Chart -->
								<div class="chart-area webDevice1">
									<div id="line-chart-01" class="webDevice1"></div>
								</div>
								<div class="chart-area mDevice1">
									<div id="mline-chart-01" class="mDevice1"></div>
								</div>
								<!--// Chart -->
							</div>
							<!--// 접속자 탭 내용 -->

							<!-- 네트워크 탭 내용 -->
							<!-- <div role="tabpanel" id="statistics-2" class="tab-pane" aria-labelledby="statistics-tab2" aria-expanded="false" >
								<div class="position-relative">
									<h4 class="card-title">네트워크</h4>
									<div class="position-absolute no-edge-top no-edge-right">
										WEB Mobile 선택
										<select name="" title="" class="form-control" id="deviceOption-2">
											<option value="deviceOption1-2" selected="selected">WEB</option>
											<option value="deviceOption2-2">Mobile</option>
										</select>	
										// WEB Mobile 선택
									</div>
								</div>
								Chart
								<div class="chart-area webDevice2">
									<div id="line-chart-02" class="webDevice2"></div>
								</div>
								<div class="chart-area mDevice2">
									<div id="mline-chart-02" class="mDevice2"></div>
								</div>
								// Chart
							</div> -->
							<!--// 네트워크 탭 내용 -->

							<!-- CPU 탭 내용 -->
							<div role="tabpanel" id="statistics-3" class="tab-pane" aria-labelledby="statistics-tab3" aria-expanded="false" >
								<div class="position-relative">
									<h4 class="card-title">CPU</h4>
									<div class="position-absolute no-edge-top no-edge-right">
										<select name="" title="" class="form-control" id="deviceOption-3" onchange="selectStreaming('cpu',this.value)">
											<option value="">선택해주세요.</option>
											<th:block  th:each="item : ${streamingList}" th:unless="${#lists.isEmpty(streamingList)}">
												<option th:value="${item.streamingSeq}" th:text="${item.streamingIp}"></option>
											</th:block>
										</select>	
									</div>
								</div>
								<!-- Chart -->
								<div class="chart-area webDevice3">
									<div id="line-chart-03" class="webDevice3"></div>
								</div>
								<div class="chart-area mDevice3">
									<div id="mline-chart-03" class="mDevice3"></div>
								</div>
								<!--// Chart -->
							</div>
							<!--// CPU 탭 내용 -->

							<!-- 메모리 탭 내용 -->
							<div role="tabpanel" id="statistics-4" class="tab-pane" aria-labelledby="statistics-tab4" aria-expanded="false" >
								<div class="position-relative">
									<h4 class="card-title d-inline mr-10">메모리</h4>

									<div class="position-absolute no-edge-top no-edge-right">
										<select name="" title="" class="form-control" id="deviceOption-4" onchange="selectStreaming('memory',this.value)">
											<option value="">선택해주세요.</option>
											<th:block  th:each="item : ${streamingList}" th:unless="${#lists.isEmpty(streamingList)}">
												<option th:value="${item.streamingSeq}" th:text="${item.streamingIp}"></option>
											</th:block>
										</select>
									</div>
									
									<div class="tab-content mt-Half">
										<!-- Live 탭 -->
										<div class="tab-pane row active" id="memory2" role="tabpanel" aria-labelledby="memory2" aria-expanded="true">
											<!-- Chart -->
											<div class="chart-area webDevice4">
												<div id="line-chart-live" class="webDevice4"></div>
											</div>
											<div class="chart-area mDevice4">
												<div id="mline-chart-live" class="mDevice4"></div>
											</div>
											<!--// Chart -->
										</div>
										<!--// Live 탭 -->
									</div>
								</div>
							</div>
							<!--// 메모리 탭 내용 -->

							<!-- 드라이브 탭 내용 -->
							<div role="tabpanel" id="statistics-5" class="tab-pane" aria-labelledby="statistics-tab5" aria-expanded="false" >
								<div class="position-relative">
									<h4 class="card-title">드라이브</h4>
									<div class="position-absolute no-edge-top no-edge-right">
										<select name="" title="" class="form-control" id="deviceOption-5" onchange="selectStreaming('drive',this.value)">
											<option value="">선택해주세요.</option>
											<th:block  th:each="item : ${streamingList}" th:unless="${#lists.isEmpty(streamingList)}">
												<option th:value="${item.streamingSeq}" th:text="${item.streamingIp}"></option>
											</th:block>
										</select>	
									</div>
								</div>
								<!-- Chart -->
								<div class="chart-area webDevice5">
									<div id="line-chart-05" class="webDevice5"></div>
								</div>
								<div class="chart-area mDevice5">
									<div id="mline-chart-05" class="mDevice5"></div>
								</div>
								<!--// Chart -->
							</div>
							<!--// 드라이브 탭 내용 -->

						</div>

					</div>
				</div>
			</div>
		</div>	
	</div>
</div>
<!--// 컨텐츠 본문 영역 -->
</div>
</div>
<!--// 컨텐츠 영역 -->

<div th:replace="inc/_footer"></div>

<!-- 전체통계 -->
<script th:src="@{/app-assets/vendors/js/charts/d3.min.js}" type="text/javascript"></script>
<script th:src="@{/app-assets/vendors/js/charts/c3.min.js}" type="text/javascript"></script>
<script language="javascript" type="text/javascript">
/*<![CDATA[*/
/*=========================================================================================
    File Name: spline.js
    Description: c3 spline chart
    ----------------------------------------------------------------------------------------
    Item Name: Robust - Responsive Admin Template
    Version: 2.0
    Author: PIXINVENT
    Author URL: http://www.themeforest.net/user/pixinvent
==========================================================================================*/

// Spline chart
// ------------------------------
$(window).on("load", function(){
	var d3locale_ko = d3.locale({
		'decimal': '.',
		'thousands': ',',
		'grouping': [3],
		'currency': ['\\', ''],
		'dateTime': '%a %b %e %X %Y',
		'date': '%Y-%m-%d',
		'time': '%H:%M:%S',
		'periods': ['AM', 'PM'],
		'days': ['일요일', '월요일', '화요일', '수요일', '목요일', '금요일', '토요일'],
		'shortDays': ['일', '월', '화', '수', '목', '금', '토'],
		'months': ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'],
		'shortMonths': ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12']
	});

	// Callback that creates and populates a data table, instantiates the spline chart, passes in the data and draws it.
	// WEB 차트


	// mobile 차트
	// 접속자 수

    /* var splineChart = c3.generate({
        bindto: '#mline-chart-01',
        size: { height: 400 },
        point: {
            r: 4
        },
        color: {
            pattern: ['#e83e8c', '#248709', '#3BAFDA', '#FFFFFF']
        },

        // Create the data table.
        data: {
			 x: 'x',
			xFormat: '%Y-%m-%d %H:%M:%S',
            columns: [
				['x', '2020-01-12 09:00:00', '2020-01-12 09:30:00', '2020-01-12 10:00:00', '2020-01-12 10:30:00', '2020-01-12 11:00:00', '2020-01-12 11:30:00', '2020-01-12 12:00:00'],
                ['data1', null, null, null, null, null, 1, 3],
				['data2', 10, 200, 100, 103, 50, 51, 63],
				['data3', null, 20, 50, 10, 40, 31, 33],
				['전체', null, null, null, null, null, null, null],
				
            ],

			names: {
						data1: 'CH 01',
						data2: 'CH 02',
						data3: 'CH 03',
						전체: ''
					},

            type: 'line',
			types: {
                전체: 'bar'
            },
        },
        axis: {
            x: {
                type: 'timeseries',
                tick: {
                    format: '%Y-%m-%d %H:%M:%S'
                }
            },
            y: {
				tick: {
					format: function (d) { return d + '명'; }
				}
            }

        },
        grid: {
            y: {
                show: true,
            }
        },

		padding: {
		  top: 10,
		  bottom: 30
		}
    });

    // Resize chart on sidebar width change
    $(".menu-toggle").on('click', function() {
        splineChart.resize();
    }); */
});


// 접속자 수
function viewsChart(data){
	
	var dateArr = ['x'];
// 	var dateArr = ['x', data.date1+'00', data.date2+'00', data.date3+'00', data.date4+'00', data.date5+'00', data.date6+'00', data.date7+'00'];
	var inboundArr = ['data1'];
	var outboundArr = ['data2'];
// 	var all = ['전체'];
	
	var totalDataArr = new Array();
	
	if(data != null){
		
		dateArr = ['x', data.date1+':00', data.date2+':00', data.date3+':00', data.date4+':00', data.date5+':00', data.date6+':00', data.date7+':00']
// 		all = ['전체', null, null, null, null, null, null, null];
		
		$.each(data.liveMonitorList, function(i){
			
			var dataArr =[this.lbTitle, this.date1, this.date2
				, this.date3, this.date4, this.date5, this.date6, this.date7];
			
			totalDataArr.push(dataArr);
			
		});
	}
	
	var columns = new Array();
	
	columns.push(dateArr);
	$.each(totalDataArr, function(i){
		columns.push(this);
	});
// 	columns.push(all);
	
    var splineChart = c3.generate({
        bindto: '#line-chart-01',
        size: { height: 400 },
        point: {
            r: 4
        },
        color: {
            pattern: ['#FFBC01', '#248709', '#3BAFDA', '#FFFFFF']
        },

        // Create the data table.
        data: {
			 x: 'x',
			xFormat: '%Y-%m-%d %H:%M:%S',
            columns: columns,
/*             columns: [
				['x', data.date1+':00', data.date2+':00', data.date3+':00', data.date4+':00', data.date5+':00', data.date6+':00', data.date7+':00'],
                ['data1', 200, 100, null, null, null, 1, 3],
				['data2', 10, 200, 100, 103, 50, 51, 63],
				['data3', null, 20, 50, 10, 40, 31, 33],
				['전체', null, null, null, null, null, null, null],
				
            ], */

			names: {
						data1: 'CH 01',
						data2: 'CH 02',
						data3: 'CH 03',
						전체: ''
					},

            type: 'line',
			types: {
                전체: 'bar'
            },
        },
        axis: {
            x: {
                type: 'timeseries',
                tick: {
                    format: '%Y-%m-%d %H:%M:%S'
                }
            },
            y: {
				tick: {
					format: function (d) { return d + '명'; }
				}
            }

        },
        grid: {
            y: {
                show: true,
            }
        },

		padding: {
		  top: 10,
		  bottom: 30
		}
    });

    // Resize chart on sidebar width change
    $(".menu-toggle").on('click', function() {
        splineChart.resize();
    });
}

function networkChart(data){
	
	var dateArr = ['x'];
	var inboundArr = ['data1'];
	var outboundArr = ['data2'];
	var all = ['전체'];
	
	$.each(data, function(i){
		dateArr.push(this.date);
		inboundArr.push(this.inbound);
		outboundArr.push(this.outbound);
		all.push(null);
	});
	
	
	//네트워크
    var splineChart = c3.generate({
        bindto: '#line-chart-02',
        size: { height: 400 },
        point: {
            r: 4
        },
        color: {
            pattern: ['#FFBC01', '#248709', '#FFFFFF']
        },

        // Create the data table.
        data: {
			 x: 'x',
			xFormat: '%Y-%m-%d %H:%M:%S',
            columns:
            [
            	dateArr,
            	inboundArr,
            	outboundArr,
            	all
            ],
//             columnsData,

			names: {
						data1: 'Bits In',
						data2: 'Bits Out',
						전체: ''
					},

            type: 'line',
			types: {
                전체: 'bar'
            },

        },
        axis: {
            x: {
                type: 'timeseries',
                tick: {
                    format: '%Y-%m-%d %H:%M:%S'
                }
            },
            y: {
				tick: {
					format: function (d) { return d + 'bits'; }
				}
            }

        },
        grid: {
            y: {
                show: true,
            }
        },

		padding: {
		  top: 10,
		  bottom: 30
		}
    });
}



function cpuChart(data){
	
	var dateArr = ['x'];
	var cpuArr = ['data1'];
	var all = ['전체'];
	
	$.each(data, function(i){
		dateArr.push(this.monitorDate+":00");
		cpuArr.push(this.monitorData);
		all.push(null);
	});
	
	//CPU사용
    var splineChart = c3.generate({
        bindto: '#line-chart-03',
        size: { height: 400 },
        point: {
            r: 4
        },
        color: {
            pattern: ['#FFBC01', '#FFFFFF']
        },

        // Create the data table.
        data: {
			 x: 'x',
			xFormat: '%Y-%m-%d %H:%M:%S',
            columns: [
            	dateArr,
            	cpuArr,
            	all
            ],

			names: {
						data1: 'CPU 사용',
						전체: ''
					},

            type: 'line',
			types: {
                전체: 'bar'
            },
        },
        axis: {
            x: {
                type: 'timeseries',
                tick: {
                    format: '%Y-%m-%d %H:%M:%S'
                }
            },
            y: {
				tick: {
					format: function (d) { return d + '%'; }
					
				}
            }

        },
        grid: {
            y: {
                show: true,
            }
        },

		padding: {
		  top: 10,
		  bottom: 30
		}
    });
}


function memoryChart(data){
	
	var dateArr = ['x'];
	var memoryArr = ['data1'];
	var all = ['전체'];
	
	$.each(data, function(i){
		dateArr.push(this.monitorDate+":00");
		memoryArr.push(this.monitorData);
		all.push(null);
	});
	
	//메모리live
    var splineChart = c3.generate({
        bindto: '#line-chart-live',
        size: { height: 400 },
        point: {
            r: 4
        },
        color: {
            pattern: ['#248709', '#FFFFFF']
        },

        // Create the data table.
        data: {
			 x: 'x',
			xFormat: '%Y-%m-%d %H:%M:%S',
            columns: [
            	dateArr,
            	memoryArr,
            	all
            ],

			names: {
						data1: '메모리 사용량',
						전체: ''
					},

            type: 'line',
			types: {
                전체: 'bar'
            },

        },
        axis: {
            x: {
                type: 'timeseries',
                tick: {
                    format: '%Y-%m-%d %H:%M:%S'
                }
            },
            y: {
				tick: {
					format: function (d) { return d + 'MB'; }
				}
            }

        },
        grid: {
            y: {
                show: true,
            }
        },

		padding: {
		  top: 10,
		  bottom: 30
		}
    });
}

function driveChart(data){
	
	var dateArr = ['x'];
	var driveArr = ['data1'];
	var all = ['전체'];
	
	$.each(data, function(i){
		dateArr.push(this.monitorDate+":00");
		driveArr.push(this.monitorData);
		all.push(null);
	});
	
	//드라이브
    var splineChart = c3.generate({
        bindto: '#line-chart-05',
        size: { height: 400 },
        point: {
            r: 4
        },
        color: {
            pattern: ['#FFBC01', '#FFFFFF']
        },

        // Create the data table.
        data: {
			 x: 'x',
			xFormat: '%Y-%m-%d %H:%M:%S',
            columns: [
            	dateArr,
            	driveArr,
            	all
            ],

			names: {
						data1: '드라이브 사용량',
						전체: ''
					},

            type: 'line',
			types: {
                전체: 'bar'
            },

        },
        axis: {
            x: {
                type: 'timeseries',
                tick: {
                    format: '%Y-%m-%d %H:%M:%S'
                }
            },
            y: {
				tick: {
					format: function (d) { return d + 'GB'; }
					
				}
            }

        },
        grid: {
            y: {
                show: true,
            }
        },

		padding: {
		  top: 10,
		  bottom: 30
		}
    });

}


/*]]*/
</script>
<!--// 전체통계 -->